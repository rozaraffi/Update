<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jago Report | Premium Finance</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-dark': '#0f172a',
            'brand-blue': '#3b82f6',
            'brand-green': '#10b981',
            'brand-red': '#ef4444',
            'background': '#f8fafc',
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
    .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); transition: all 0.3s ease; }
    .edit-mode-active { border: 2px solid #3b82f6 !important; background-color: #f0f7ff !important; transform: scale(1.01); }
    .fade-in { animation: fadeInUp 0.5s ease-out forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    
    .suggest-box {
        position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background: white;
        border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;
        overflow: hidden; margin-top: 4px; display: none;
    }
    .suggest-item { padding: 10px 12px; font-size: 11px; font-weight: 600; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
    .suggest-item:hover { background-color: #eff6ff; color: #3b82f6; }
  </style>
</head>
<body class="p-4 sm:p-8">
  <div class="max-w-7xl mx-auto">
    
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 fade-in">
      <div>
        <a href="index.html" class="text-brand-blue text-sm font-bold flex items-center gap-2 mb-2">
            <i class="fas fa-arrow-left"></i> Dashboard
        </a>
        <h1 class="text-3xl font-extrabold text-brand-dark flex items-center gap-3">
          <i class="fas fa-university text-brand-blue"></i> Rekening: <span id="rekeningNama">JAGO</span>
        </h1>
      </div>
      
      <div class="flex gap-3">
        <div class="flex bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <select id="bulanFilter" class="px-4 py-2 border-none text-sm font-semibold cursor-pointer"></select>
            <select id="tahunFilter" class="px-4 py-2 border-none text-sm font-semibold cursor-pointer"></select>
        </div>
        <button id="btnTampilkan" onclick="renderAll()" class="bg-brand-blue text-white px-5 py-2 rounded-xl text-sm font-bold shadow-sm">Tampilkan</button>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div class="glass-card p-8 rounded-3xl border-l-4 border-brand-blue flex flex-col justify-center fade-in">
        <h2 class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Total Saldo Jago</h2>
        <p id="saldoRekening" class="text-3xl font-extrabold text-brand-dark">Rp 0</p>
      </div>
      
      <div id="formContainer" class="lg:col-span-2 glass-card p-6 rounded-3xl fade-in relative">
        <div class="flex justify-between items-center mb-4">
            <h3 id="formTitle" class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest">Input Transaksi Jago</h3>
            <button id="cancelEdit" onclick="resetForm()" class="hidden text-xs font-bold text-brand-red flex items-center gap-1">
                <i class="fas fa-times-circle"></i> Batal Edit
            </button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <input type="date" id="tanggal" class="text-xs p-3 rounded-xl border border-slate-100 outline-none bg-white">
            <div class="relative">
                <input type="text" id="akun" autocomplete="off" placeholder="Nama Akun" class="w-full text-xs p-3 rounded-xl border border-slate-100 outline-none bg-white">
                <div id="suggestBox" class="suggest-box"></div>
            </div>
            <select id="jenis" class="text-xs p-3 rounded-xl border border-slate-100 outline-none bg-white">
                <option value="pemasukan">Pemasukan</option>
                <option value="pengeluaran">Pengeluaran</option>
            </select>
            <input type="text" id="nominalInputFormatted" placeholder="Nominal" class="text-xs p-3 rounded-xl border border-slate-100 outline-none font-bold text-brand-blue bg-white">
        </div>
        <div class="mt-3 flex gap-3">
            <input type="text" id="keterangan" placeholder="Keterangan..." class="flex-1 text-xs p-3 rounded-xl border border-slate-100 outline-none bg-white">
            <input type="hidden" id="editTimestamp" value="">
            <button id="tambahBtn" onclick="simpanTransaksi()" class="btn-primary text-white px-8 py-3 rounded-xl text-xs font-bold">Simpan</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8 fade-in">
        <div class="lg:col-span-2 glass-card p-6 rounded-3xl">
            <h3 class="font-bold text-slate-700 mb-4 text-sm flex items-center gap-2">
                <i class="fas fa-chart-pie text-brand-blue"></i> Arus Kas Jago
            </h3>
            <div class="h-44 w-full"><canvas id="pieChart"></canvas></div>
        </div>
        <div class="glass-card p-6 rounded-3xl">
            <h3 class="font-bold text-brand-green mb-4 text-sm flex items-center gap-2">
                <i class="fas fa-arrow-up"></i> Top Pendapatan
            </h3>
            <ul id="topPendapatan" class="space-y-2"></ul>
        </div>
        <div class="glass-card p-6 rounded-3xl">
            <h3 class="font-bold text-brand-red mb-4 text-sm flex items-center gap-2">
                <i class="fas fa-arrow-down"></i> Top Pengeluaran
            </h3>
            <ul id="topPengeluaran" class="space-y-2"></ul>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 glass-card p-6 rounded-3xl fade-in">
            <h3 class="font-bold text-slate-700 mb-6 text-sm">Rincian Buku Besar Jago</h3>
            <div id="bukuBesar" class="space-y-6"></div>
        </div>
        <div class="glass-card p-6 rounded-3xl fade-in h-fit">
            <h3 class="font-bold text-slate-700 mb-4 text-sm">Neraca Saldo</h3>
            <table class="w-full text-left text-[11px]">
                <tbody id="neracaSaldo" class="divide-y divide-slate-50"></tbody>
            </table>
        </div>
    </div>
  </div>

  <script>
    const rekeningKey = 'transaksi_rekening_JAGO'; // Kunci unik untuk Jago
    
    const formatRp = (n) => "Rp " + Math.abs(Number(n)).toLocaleString('id-ID');
    const cleanNum = (s) => parseInt(String(s).replace(/\D/g, ''), 10) || 0;

    // Filter Init
    const bulanFilterEl = document.getElementById('bulanFilter');
    const tahunFilterEl = document.getElementById('tahunFilter');
    const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    months.forEach((m, i) => bulanFilterEl.innerHTML += `<option value="${i + 1}" ${i === new Date().getMonth() ? 'selected' : ''}>${m}</option>`);
    for (let y = 2023; y <= 2030; y++) tahunFilterEl.innerHTML += `<option value="${y}" ${y === new Date().getFullYear() ? 'selected' : ''}>${y}</option>`;

    // --- AUTO SUGGEST ---
    const inputAkun = document.getElementById('akun');
    const suggestBox = document.getElementById('suggestBox');
    inputAkun.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        suggestBox.innerHTML = '';
        if (!val) { suggestBox.style.display = 'none'; return; }
        const currentData = JSON.parse(localStorage.getItem(rekeningKey)) || [];
        const uniqueAkun = [...new Set(currentData.map(t => t.akun))];
        const matches = uniqueAkun.filter(a => a.toLowerCase().includes(val)).slice(0, 3);
        if (matches.length > 0) {
            matches.forEach(m => {
                const div = document.createElement('div');
                div.className = 'suggest-item';
                div.innerHTML = `<i class="fas fa-history mr-2 text-slate-300"></i>${m}`;
                div.onclick = () => { inputAkun.value = m; suggestBox.style.display = 'none'; };
                suggestBox.appendChild(div);
            });
            suggestBox.style.display = 'block';
        } else { suggestBox.style.display = 'none'; }
    });
    document.addEventListener('click', (e) => { if (e.target !== inputAkun) suggestBox.style.display = 'none'; });

    document.getElementById('nominalInputFormatted').addEventListener('input', (e) => {
        let v = cleanNum(e.target.value);
        e.target.value = v ? v.toLocaleString('id-ID') : '';
    });

    // --- LOGIKA EDIT & SIMPAN ---
    function simpanTransaksi() {
        const tsField = document.getElementById('editTimestamp').value;
        const val = cleanNum(document.getElementById('nominalInputFormatted').value);
        const tglVal = document.getElementById('tanggal').value;
        const akunVal = document.getElementById('akun').value || 'Umum';
        if(!tglVal || val <= 0) { alert("Isi tanggal dan nominal!"); return; }

        let allData = JSON.parse(localStorage.getItem(rekeningKey)) || [];

        if (tsField !== "") {
            const targetTS = Number(tsField);
            const index = allData.findIndex(t => Number(t.timestamp) === targetTS);
            if (index !== -1) {
                allData[index] = { tgl: tglVal, akun: akunVal, jenis: document.getElementById('jenis').value, nominal: val, ket: document.getElementById('keterangan').value, timestamp: targetTS };
            }
        } else {
            allData.push({ tgl: tglVal, akun: akunVal, jenis: document.getElementById('jenis').value, nominal: val, ket: document.getElementById('keterangan').value, timestamp: Date.now() + Math.floor(Math.random() * 1000) });
        }

        localStorage.setItem(rekeningKey, JSON.stringify(allData));
        resetForm();
        renderAll();
    }

    function siapkanEdit(ts) {
        const targetTS = Number(ts);
        const allData = JSON.parse(localStorage.getItem(rekeningKey)) || [];
        const data = allData.find(t => Number(t.timestamp) === targetTS);
        if(!data) { alert("Data tidak ditemukan!"); return; }

        document.getElementById('tanggal').value = data.tgl;
        document.getElementById('akun').value = data.akun;
        document.getElementById('jenis').value = data.jenis;
        document.getElementById('nominalInputFormatted').value = data.nominal.toLocaleString('id-ID');
        document.getElementById('keterangan').value = data.ket || '';
        document.getElementById('editTimestamp').value = targetTS;

        document.getElementById('formContainer').classList.add('edit-mode-active');
        document.getElementById('formTitle').textContent = "SEDANG EDIT JAGO: " + data.akun.toUpperCase();
        document.getElementById('formTitle').style.color = "#3b82f6";
        document.getElementById('cancelEdit').classList.remove('hidden');
        document.getElementById('tambahBtn').textContent = "Update Data";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetForm() {
        document.getElementById('editTimestamp').value = "";
        document.getElementById('akun').value = "";
        document.getElementById('nominalInputFormatted').value = "";
        document.getElementById('keterangan').value = "";
        document.getElementById('tanggal').valueAsDate = new Date();
        document.getElementById('formContainer').classList.remove('edit-mode-active');
        document.getElementById('formTitle').textContent = "INPUT TRANSAKSI JAGO";
        document.getElementById('formTitle').style.color = "";
        document.getElementById('cancelEdit').classList.add('hidden');
        document.getElementById('tambahBtn').textContent = "Simpan";
    }

    function renderAll() {
        const allData = JSON.parse(localStorage.getItem(rekeningKey)) || [];
        const bln = parseInt(bulanFilterEl.value);
        const thn = parseInt(tahunFilterEl.value);
        const filtered = allData.filter(t => {
            const d = new Date(t.tgl);
            return (d.getMonth() + 1) === bln && d.getFullYear() === thn;
        });
        const totalSaldo = allData.reduce((a, t) => a + (t.jenis === 'pemasukan' ? t.nominal : -t.nominal), 0);
        document.getElementById('saldoRekening').textContent = formatRp(totalSaldo);
        updateHighlights(filtered);
        updateBukuBesar(filtered);
        updateNeraca(filtered);
        updateCharts(filtered);
    }

    function updateHighlights(data) {
        const pureData = data.filter(t => !t.akun.toLowerCase().includes('transfer'));
        const renderList = (elementId, type, colorClass) => {
            const list = pureData.filter(t => t.jenis === type).sort((a, b) => b.nominal - a.nominal).slice(0, 3);
            const el = document.getElementById(elementId);
            if(list.length === 0) { el.innerHTML = `<li class="text-[10px] text-slate-400 italic">No data</li>`; return; }
            el.innerHTML = list.map(t => `<li class="flex justify-between items-center bg-white p-2.5 rounded-xl border border-slate-100 shadow-sm"><span class="text-[9px] font-bold text-slate-500 uppercase truncate mr-2">${t.akun}</span><span class="text-[10px] font-extrabold ${colorClass}">${formatRp(t.nominal)}</span></li>`).join('');
        };
        renderList('topPendapatan', 'pemasukan', 'text-brand-green');
        renderList('topPengeluaran', 'pengeluaran', 'text-brand-red');
    }

    function updateBukuBesar(data) {
        const container = document.getElementById('bukuBesar');
        container.innerHTML = '';
        const grouped = {};
        data.sort((a,b) => new Date(b.tgl) - new Date(a.tgl)).forEach(t => {
            if(!grouped[t.akun]) grouped[t.akun] = [];
            grouped[t.akun].push(t);
        });
        Object.keys(grouped).forEach(akun => {
            let rows = grouped[akun].map(t => `<tr class="hover:bg-slate-50 group border-b border-slate-50 last:border-0 text-[11px]"><td class="p-3 text-slate-400">${t.tgl.split('-').reverse().join('/')}</td><td class="p-3 font-bold ${t.jenis === 'pemasukan' ? 'text-brand-green' : 'text-brand-red'}">${formatRp(t.nominal)}</td><td class="p-3 text-slate-500 italic truncate max-w-[150px]">${t.ket || '-'}</td><td class="p-3 text-right flex gap-3 justify-end opacity-20 group-hover:opacity-100"><button onclick="siapkanEdit(${t.timestamp})" class="text-brand-blue hover:scale-125"><i class="fas fa-edit"></i></button><button onclick="hapusTransaksi(${t.timestamp})" class="text-brand-red hover:scale-125"><i class="fas fa-trash-alt"></i></button></td></tr>`).join('');
            container.innerHTML += `<div class="border border-slate-100 rounded-2xl overflow-hidden mb-4 shadow-sm bg-white"><div class="bg-slate-50 px-4 py-2 text-[9px] font-bold text-slate-500 uppercase">${akun}</div><table class="w-full text-left"><tbody>${rows}</tbody></table></div>`;
        });
    }

    function updateNeraca(data) {
        const neraca = {};
        let tD = 0, tK = 0;
        data.forEach(t => {
            if (!neraca[t.akun]) neraca[t.akun] = { d: 0, k: 0 };
            if (t.jenis === 'pemasukan') { neraca[t.akun].d += t.nominal; tD += t.nominal; }
            else { neraca[t.akun].k += t.nominal; tK += t.nominal; }
        });
        const tbody = document.getElementById('neracaSaldo');
        tbody.innerHTML = '';
        Object.keys(neraca).forEach(a => {
            tbody.innerHTML += `<tr><td class="p-2 text-slate-600 font-medium">${a}</td><td class="p-2 text-right text-brand-green font-bold">${formatRp(neraca[a].d)}</td><td class="p-2 text-right text-brand-red font-bold">${formatRp(neraca[a].k)}</td></tr>`;
        });
        if (Object.keys(neraca).length > 0) {
            tbody.innerHTML += `<tr class="bg-slate-50 font-extrabold border-t-2 border-slate-200"><td class="p-2">TOTAL</td><td class="p-2 text-right text-brand-green underline">${formatRp(tD)}</td><td class="p-2 text-right text-brand-red underline">${formatRp(tK)}</td></tr>`;
        }
    }

    let pieC;
    function updateCharts(data) {
        const pin = data.filter(t => t.jenis === 'pemasukan').reduce((a,b)=>a+b.nominal, 0);
        const pout = data.filter(t => t.jenis === 'pengeluaran').reduce((a,b)=>a+b.nominal, 0);
        if(pieC) pieC.destroy();
        pieC = new Chart(document.getElementById('pieChart'), {
            type: 'bar',
            data: { labels: ['Masuk', 'Keluar'], datasets: [{ data: [pin, pout], backgroundColor: ['#10b981', '#ef4444'], borderRadius: 8 }] },
            options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { display: false } } } }
        });
    }

    function hapusTransaksi(ts) {
        if(confirm('Hapus transaksi jago ini?')) {
            let allData = JSON.parse(localStorage.getItem(rekeningKey)) || [];
            allData = allData.filter(t => Number(t.timestamp) !== Number(ts));
            localStorage.setItem(rekeningKey, JSON.stringify(allData));
            renderAll();
        }
    }

    document.getElementById('tanggal').valueAsDate = new Date();
    renderAll();
  </script>
</body>
</html>
